<html>
    <head></head>
    <body>
        <h1>Passkey</h1>

        <div style="margin-bottom: 100px">
            <div style="display: flex; flex-direction: column; width: 250px; margin-bottom: 10px;">
                <label for="register-login">Login</label>
                <input id="register-login" type="text" placeholder="login" />
            </div>
            <div style="display: flex; flex-direction: column; width: 250px; margin-bottom: 10px;">
                <label for="register-password">Password</label>
                <input id="register-password" type="password" placeholder="password" />
            </div>
            <button id="register-btn">Register</button>
        </div>

        <div>
            <div style="display: flex; flex-direction: column; width: 250px; margin-bottom: 10px;">
                <label for="authenticate-login">Login</label>
                <input id="authenticate-login" type="text" placeholder="login" />
            </div>

            <button id="authenticate-btn">Authenticate</button>
        </div>
    </body>
</html>

<script type="application/javascript">
    function recursiveBase64StrToArrayBuffer(obj) {
        let prefix = '=?BINARY?B?';
        let suffix = '?=';
        if (typeof obj === 'object') {
            for (let key in obj) {
                if (typeof obj[key] === 'string') {
                    let str = obj[key];
                    if (str.substring(0, prefix.length) === prefix && str.substring(str.length - suffix.length) === suffix) {
                        str = str.substring(prefix.length, str.length - suffix.length);

                        let binary_string = window.atob(str);
                        let len = binary_string.length;
                        let bytes = new Uint8Array(len);
                        for (let i = 0; i < len; i++)        {
                            bytes[i] = binary_string.charCodeAt(i);
                        }
                        obj[key] = bytes.buffer;
                    }
                } else {
                    recursiveBase64StrToArrayBuffer(obj[key]);
                }
            }
        }
    }

    function arrayBufferToBase64(buffer) {
        let binary = '';
        let bytes = new Uint8Array(buffer);
        let len = bytes.byteLength;
        for (let i = 0; i < len; i++) {
            binary += String.fromCharCode( bytes[ i ] );
        }
        return window.btoa(binary);
    }

    document.getElementById('register-btn').addEventListener('click', async () => {
        const login = document.getElementById('register-login').value;
        const password = document.getElementById('register-password').value;

        const response = await fetch(`http://equal.local?get=core_user_passkey-register-options&login=${login}&password=${password}`);
        const options = await response.json();

        const registerToken = options.register_token;
        delete options.register_token;

        recursiveBase64StrToArrayBuffer(options);

        const credential = await navigator.credentials.create(options);

        const authenticatorAttestationResponse = {
            register_token: registerToken,
            transports: credential.response.getTransports ? credential.response.getTransports() : null,
            client_data_json: credential.response.clientDataJSON ? arrayBufferToBase64(credential.response.clientDataJSON) : null,
            attestation_object: credential.response.attestationObject ? arrayBufferToBase64(credential.response.attestationObject) : null
        };

        const result = await fetch('http://equal.local?do=core_user_passkey-register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(authenticatorAttestationResponse),
            cache: 'no-cache'
        });

        const data = await result.json();
        if (data.success) {
            alert('Registration successful!');
        } else {
            alert('Registration failed!');
        }
    });

    document.getElementById('authenticate-btn').addEventListener('click', async () => {
        const login = document.getElementById('authenticate-login').value;

        const response = await fetch(`http://equal.local?get=core_user_passkey-auth-options&login=${login}`);
        const options = await response.json();

        const authToken = options.auth_token;
        delete options.auth_token;

        recursiveBase64StrToArrayBuffer(options);

        const credential = await navigator.credentials.get(options);

        const authenticatorAttestationResponse = {
            auth_token: authToken,
            credential_id: credential.rawId ? arrayBufferToBase64(credential.rawId) : null,
            client_data_json: credential.response.clientDataJSON ? arrayBufferToBase64(credential.response.clientDataJSON) : null,
            authenticator_data: credential.response.authenticatorData ? arrayBufferToBase64(credential.response.authenticatorData) : null,
            signature: credential.response.signature ? arrayBufferToBase64(credential.response.signature) : null,
            user_handle: credential.response.userHandle ? arrayBufferToBase64(credential.response.userHandle) : null
        };

        const result = await fetch('http://equal.local?do=core_user_passkey-auth', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(authenticatorAttestationResponse),
            cache: 'no-cache'
        });

        const data = await result.json();
        if (data.success) {
            alert('Authentication successful!');
        } else {
            alert('Authentication failed!');
        }
    });
</script>
